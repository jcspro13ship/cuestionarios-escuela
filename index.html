<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fequundar - Cuestionarios</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            width: 100%;
            background: #ffffff;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            position: relative;
        }
        .header img { height: 65px; object-fit: contain; }
        .admin-btn {
            position: absolute; right: 16px; top: 50%;
            transform: translateY(-50%);
            background: #f5f5f5; border: 1px solid #ddd;
            color: #bbb; font-size: 1.1rem; cursor: pointer;
            padding: 6px 10px; border-radius: 6px; transition: all 0.2s;
        }
        .admin-btn:hover { background: #e8eaf6; color: #3f51b5; }
        .page { width: 100%; max-width: 680px; padding: 28px 16px; }
        .card {
            background: white; border-radius: 16px;
            padding: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.07);
        }
        h2 { color: #0d1b2a; margin-bottom: 6px; font-size: 1.4rem; }
        .subtitle { color: #888; margin-bottom: 22px; font-size: 0.9rem; }
        .form-group { margin-bottom: 16px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #333; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%; padding: 10px 14px;
            border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 1rem; font-family: inherit; transition: border 0.2s; background: white;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #1a6fc4; }
        textarea { resize: vertical; min-height: 65px; }
        .btn {
            background: #1a6fc4; color: white; border: none;
            padding: 13px 20px; border-radius: 8px; font-size: 0.97rem;
            cursor: pointer; width: 100%; margin-top: 8px;
            transition: background 0.2s; font-family: inherit; font-weight: 600;
        }
        .btn:hover { background: #155fa0; }
        .btn:disabled { background: #b0bec5; cursor: not-allowed; }
        .btn-secondary {
            background: white; color: #1a6fc4;
            border: 2px solid #1a6fc4; margin-top: 10px;
        }
        .btn-secondary:hover { background: #e8f0fb; }
        .btn-danger {
            background: white; color: #c62828;
            border: 2px solid #c62828; margin-top: 6px;
        }
        .btn-danger:hover { background: #ffebee; }
        .btn-success { background: #2e7d32; }
        .btn-success:hover { background: #1b5e20; }
        .btn-sm { padding: 6px 14px; font-size: 0.82rem; width: auto; margin: 0; font-weight: 500; }

        /* CAT√ÅLOGO */
        .bienvenida {
            background: #e8f0fb; border-radius: 10px;
            padding: 12px 16px; margin-bottom: 20px; color: #0d1b2a; font-size: 0.93rem;
        }
        .cuestionarios-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        @media(max-width:480px){ .cuestionarios-grid { grid-template-columns: 1fr; } }
        .quiz-card {
            border: 2px solid #e0e0e0; border-radius: 12px;
            padding: 18px; cursor: pointer; transition: all 0.2s; text-align: center; background: white;
        }
        .quiz-card:hover { border-color: #1a6fc4; background: #f0f5ff; transform: translateY(-2px); }
        .quiz-card .emoji { font-size: 2rem; margin-bottom: 8px; }
        .quiz-card .titulo { font-weight: 700; color: #0d1b2a; font-size: 0.95rem; }
        .quiz-card .desc { color: #777; font-size: 0.79rem; margin-top: 4px; }
        .quiz-card .npregs { color: #1a6fc4; font-size: 0.78rem; margin-top: 8px; font-weight: 600; }

        /* QUIZ ‚Äî UNA PREGUNTA A LA VEZ */
        .quiz-top {
            display: flex; align-items: center;
            justify-content: space-between; margin-bottom: 6px;
        }
        .quiz-top h2 { margin-bottom: 0; }
        .pregunta-badge {
            background: #e8f0fb; color: #1a6fc4;
            font-weight: 700; font-size: 0.85rem;
            padding: 4px 12px; border-radius: 20px; white-space: nowrap;
        }
        .progress { background: #e0e0e0; border-radius: 8px; height: 7px; margin: 12px 0 20px; overflow: hidden; }
        .progress-bar { background: #1a6fc4; height: 100%; border-radius: 8px; transition: width 0.5s ease; }
        .question-card {
            background: #f6f9ff; border-radius: 14px;
            padding: 22px; margin-bottom: 18px; border-left: 5px solid #1a6fc4;
        }
        .question-text { font-weight: 700; color: #0d1b2a; font-size: 1rem; margin-bottom: 18px; line-height: 1.5; }
        .options { display: flex; flex-direction: column; gap: 8px; }
        .option-btn {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px; border-radius: 10px;
            border: 2px solid #e0e0e0; background: white;
            cursor: pointer; font-size: 0.93rem; font-family: inherit;
            text-align: left; transition: all 0.2s; font-weight: 500; color: #333;
        }
        .option-btn:hover:not(:disabled) { border-color: #1a6fc4; background: #e8f0fb; }
        .option-btn:disabled { cursor: default; }
        .option-btn .letra {
            width: 28px; height: 28px; border-radius: 50%;
            background: #e8eaf6; color: #3f51b5;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.82rem; flex-shrink: 0; transition: all 0.2s;
        }
        .option-btn.correcta { border-color: #4caf50; background: #f1f8e9; }
        .option-btn.correcta .letra { background: #4caf50; color: white; }
        .option-btn.incorrecta { border-color: #f44336; background: #fff3e0; }
        .option-btn.incorrecta .letra { background: #f44336; color: white; }
        .option-btn.opacada { opacity: 0.45; }

        /* FEEDBACK INLINE */
        .feedback-inline {
            border-radius: 12px; padding: 16px 18px;
            margin-top: 16px; display: none;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
        .feedback-inline.correcto { background: #f1f8e9; border: 2px solid #4caf50; }
        .feedback-inline.incorrecto { background: #fff3e0; border: 2px solid #ff9800; }
        .fb-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .fb-icon { font-size: 1.4rem; }
        .fb-titulo { font-weight: 700; font-size: 0.97rem; }
        .fb-titulo.correcto { color: #2e7d32; }
        .fb-titulo.incorrecto { color: #e65100; }
        .fb-correcta { font-size: 0.88rem; color: #555; margin-bottom: 8px; }
        .fb-correcta strong { color: #2e7d32; }
        .fb-explicacion {
            background: rgba(0,0,0,0.04); border-radius: 8px;
            padding: 10px 12px; font-size: 0.86rem; color: #555; line-height: 1.55;
        }
        .fb-explicacion strong { color: #0d1b2a; }

        /* RESULTADO FINAL */
        #result-section { text-align: center; }
        .score-circle {
            width: 120px; height: 120px; border-radius: 50%;
            color: white; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            margin: 0 auto 16px; font-size: 2.2rem; font-weight: 700;
        }
        .score-circle span { font-size: 0.82rem; font-weight: 400; }
        .score-excelente { background: #2e7d32; }
        .score-bien      { background: #f57f17; }
        .score-bajo      { background: #c62828; }
        .result-msg { color: #555; font-size: 1rem; margin-bottom: 6px; }
        .saving-msg { color: #1a6fc4; font-style: italic; font-size: 0.87rem; margin-top: 8px; }
        .resumen-grid {
            display: grid; grid-template-columns: repeat(3,1fr);
            gap: 10px; margin: 20px 0;
        }
        .resumen-box {
            background: #f6f9ff; border-radius: 10px;
            padding: 14px 8px; border: 1px solid #d0dff5;
        }
        .resumen-box .val { font-size: 1.5rem; font-weight: 700; color: #1a6fc4; }
        .resumen-box .lbl { font-size: 0.74rem; color: #999; margin-top: 2px; }

        /* ADMIN */
        .admin-tabs { display: flex; gap: 4px; margin-bottom: 20px; }
        .tab-btn {
            flex: 1; padding: 10px; border: 2px solid #e0e0e0;
            border-radius: 8px; background: white; cursor: pointer;
            font-size: 0.88rem; font-weight: 600; color: #777;
            transition: all 0.2s; font-family: inherit;
        }
        .tab-btn.active { background: #1a6fc4; color: white; border-color: #1a6fc4; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section-title {
            font-size: 0.93rem; font-weight: 700; color: #0d1b2a;
            margin: 20px 0 12px; padding-bottom: 6px;
            border-bottom: 2px solid #e8eaf6;
        }
        .section-title:first-child { margin-top: 0; }
        .quiz-admin-item {
            border: 2px solid #e0e0e0; border-radius: 10px;
            padding: 12px 16px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px;
        }
        .quiz-admin-item .info { flex: 1; }
        .quiz-admin-item .info strong { display: block; color: #0d1b2a; font-size: 0.92rem; }
        .quiz-admin-item .info span { color: #999; font-size: 0.8rem; }
        .quiz-admin-item .actions { display: flex; gap: 6px; }
        .pregunta-admin {
            background: #f6f9ff; border-radius: 8px;
            padding: 14px; margin-bottom: 10px; border: 1px solid #d0dff5;
        }
        .pregunta-admin input { margin-bottom: 6px; }
        .opciones-admin { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
        @media(max-width:480px){ .opciones-admin { grid-template-columns: 1fr; } }
        .correcta-row {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.86rem; color: #555; flex-wrap: wrap;
        }
        .correcta-row select { padding: 5px 8px; font-size: 0.86rem; width: auto; }

        /* RESULTADOS ADMIN */
        .stats-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 20px; }
        @media(max-width:480px){ .stats-grid { grid-template-columns: 1fr 1fr; } }
        .stat-box {
            background: #f6f9ff; border-radius: 10px;
            padding: 14px; text-align: center; border: 1px solid #d0dff5;
        }
        .stat-box .val { font-size: 1.5rem; font-weight: 700; color: #1a6fc4; }
        .stat-box .lbl { font-size: 0.74rem; color: #888; margin-top: 2px; }
        .por-quiz-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; border-radius: 8px; margin-bottom: 6px;
            background: #f6f9ff; border: 1px solid #d0dff5; font-size: 0.88rem; flex-wrap: wrap; gap: 6px;
        }
        .por-quiz-row .qname { font-weight: 700; color: #0d1b2a; }
        .por-quiz-row .qstats { color: #888; font-size: 0.81rem; }
        .results-filters { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
        .results-filters input, .results-filters select { padding: 8px 12px; font-size: 0.87rem; flex: 1; min-width: 140px; }
        .results-table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.84rem; }
        thead tr { background: #0d1b2a; color: white; }
        th { padding: 10px 12px; text-align: left; font-weight: 600; white-space: nowrap; }
        td { padding: 9px 12px; border-bottom: 1px solid #eee; }
        tr:hover td { background: #f6f9ff; }
        .pct-badge {
            display: inline-block; padding: 3px 10px;
            border-radius: 20px; font-weight: 700; font-size: 0.79rem;
        }
        .pct-high { background: #c8e6c9; color: #1b5e20; }
        .pct-mid  { background: #fff9c4; color: #f57f17; }
        .pct-low  { background: #ffccbc; color: #bf360c; }
        .estudiante-row { cursor: pointer; }
        .estudiante-row:hover td { background: #e8f0fb !important; }
        .detalle-row { display: none; }
        .detalle-row td { background: #fafafa; padding: 0; }
        .detalle-inner { padding: 10px 16px; }
        .intento-line {
            display: flex; align-items: center; gap: 10px;
            padding: 6px 0; border-bottom: 1px solid #eee;
            font-size: 0.82rem; flex-wrap: wrap;
        }
        .intento-line:last-child { border-bottom: none; }

        /* MODAL */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.5); z-index: 100;
            align-items: center; justify-content: center; padding: 16px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white; border-radius: 16px; padding: 26px;
            width: 100%; max-width: 600px; max-height: 92vh; overflow-y: auto;
        }
        .modal h3 { color: #0d1b2a; margin-bottom: 18px; }
        .hidden { display: none !important; }
        .loading-msg { text-align: center; color: #aaa; padding: 30px; font-style: italic; }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <img src="fequundar-logo.png" alt="Fequundar">
    <button class="admin-btn" onclick="abrirLoginAdmin()" title="Administrador">‚öôÔ∏è</button>
</div>

<div class="page">

    <!-- 1. LOGIN -->
    <div id="login-section" class="card">
        <h2>Bienvenido</h2>
        <p class="subtitle">Ingresa tus datos para continuar</p>
        <div class="form-group">
            <label>Nombre completo</label>
            <input type="text" id="inp-nombre" placeholder="Ej: Carlos Ram√≠rez"
                onkeydown="if(event.key==='Enter') document.getElementById('inp-cedula').focus()">
        </div>
        <div class="form-group">
            <label>N√∫mero de identificaci√≥n</label>
            <input type="text" id="inp-cedula" placeholder="Ej: 1234567890"
                onkeydown="if(event.key==='Enter') entrar()">
        </div>
        <button class="btn" onclick="entrar()">Ver cuestionarios ‚Üí</button>
    </div>

    <!-- 2. CAT√ÅLOGO -->
    <div id="catalogo-section" class="card hidden">
        <h2>Cuestionarios disponibles</h2>
        <div class="bienvenida" id="bienvenida-msg"></div>
        <div class="cuestionarios-grid" id="cuestionarios-grid"></div>
        <button class="btn btn-secondary" onclick="cerrarSesion()" style="margin-top:20px">‚Üê Cerrar sesi√≥n</button>
    </div>

    <!-- 3. QUIZ -->
    <div id="quiz-section" class="card hidden">
        <div class="quiz-top">
            <h2 id="quiz-title" style="font-size:1.1rem"></h2>
            <span class="pregunta-badge" id="pregunta-badge">1 / 5</span>
        </div>
        <p class="subtitle" id="quiz-alumno" style="margin-bottom:0"></p>
        <div class="progress"><div class="progress-bar" id="progress-bar"></div></div>

        <div class="question-card">
            <p class="question-text" id="question-text"></p>
            <div class="options" id="options-container"></div>
            <div class="feedback-inline" id="feedback-inline">
                <div class="fb-header">
                    <span class="fb-icon" id="fb-icon"></span>
                    <span class="fb-titulo" id="fb-titulo"></span>
                </div>
                <p class="fb-correcta" id="fb-correcta"></p>
                <div class="fb-explicacion" id="fb-explicacion"></div>
            </div>
        </div>

        <button class="btn" id="btn-confirmar" onclick="confirmarRespuesta()">Confirmar respuesta</button>
        <button class="btn btn-secondary" id="btn-siguiente" onclick="siguientePregunta()" style="display:none"></button>
    </div>

    <!-- 4. RESULTADO FINAL -->
    <div id="result-section" class="card hidden">
        <div style="text-align:center">
            <div class="score-circle" id="score-circle">
                <div id="score-number">0</div>
                <span>de <span id="score-total">0</span></span>
            </div>
            <h2 id="result-titulo"></h2>
            <p class="result-msg" id="result-msg"></p>
            <p class="saving-msg" id="saving-msg">üíæ Guardando resultado...</p>
            <p id="sheets-status"></p>
            <div class="resumen-grid" id="resumen-grid"></div>
        </div>
        <button class="btn btn-success" onclick="mostrarCatalogo()">‚Üê Hacer otro cuestionario</button>
        <button class="btn btn-secondary" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
    </div>

</div>

<!-- MODAL LOGIN ADMIN -->
<div class="modal-overlay" id="modal-login-admin">
    <div class="modal">
        <h3>üîê Acceso Administrador</h3>
        <div class="form-group">
            <label>Contrase√±a</label>
            <input type="password" id="inp-admin-pass" placeholder="Contrase√±a"
                onkeydown="if(event.key==='Enter') verificarAdmin()">
        </div>
        <button class="btn" onclick="verificarAdmin()">Entrar</button>
        <button class="btn btn-secondary" onclick="cerrarModal('modal-login-admin')">Cancelar</button>
    </div>
</div>

<!-- MODAL PANEL ADMIN -->
<div class="modal-overlay" id="modal-admin">
    <div class="modal">
        <h3>‚öôÔ∏è Panel de Administraci√≥n</h3>
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="cambiarTab('tab-cuestionarios',this)">üìù Cuestionarios</button>
            <button class="tab-btn" onclick="cambiarTab('tab-resultados',this)">üìä Resultados</button>
        </div>

        <!-- TAB CUESTIONARIOS -->
        <div id="tab-cuestionarios" class="tab-content active">
            <div class="section-title">Cuestionarios actuales</div>
            <div id="admin-lista-cuestionarios"></div>
            <div class="section-title">‚ûï Crear nuevo cuestionario</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
                <div class="form-group" style="width:72px;flex-shrink:0">
                    <label>Emoji</label>
                    <input type="text" id="new-emoji" placeholder="üìù">
                </div>
                <div class="form-group" style="flex:1;min-width:180px">
                    <label>T√≠tulo</label>
                    <input type="text" id="new-titulo" placeholder="Ej: Anatom√≠a Reproductiva">
                </div>
            </div>
            <div class="form-group">
                <label>Descripci√≥n corta</label>
                <input type="text" id="new-desc" placeholder="Ej: √ìrganos y estructuras del sistema reproductivo">
            </div>
            <button class="btn" onclick="crearCuestionario()">Crear cuestionario vac√≠o</button>
            <button class="btn btn-secondary" onclick="cerrarModal('modal-admin')">Cerrar panel</button>
        </div>

        <!-- TAB RESULTADOS -->
        <div id="tab-resultados" class="tab-content">
            <div id="resultados-contenido">
                <div class="loading-msg">Cargando resultados...</div>
            </div>
            <button class="btn btn-secondary" onclick="cerrarModal('modal-admin')" style="margin-top:14px">Cerrar panel</button>
        </div>
    </div>
</div>

<!-- MODAL EDITAR CUESTIONARIO -->
<div class="modal-overlay" id="modal-editar">
    <div class="modal">
        <h3 id="editar-titulo-modal">Editar cuestionario</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="form-group" style="width:72px;flex-shrink:0">
                <label>Emoji</label>
                <input type="text" id="edit-emoji">
            </div>
            <div class="form-group" style="flex:1;min-width:180px">
                <label>T√≠tulo</label>
                <input type="text" id="edit-titulo">
            </div>
        </div>
        <div class="form-group">
            <label>Descripci√≥n</label>
            <input type="text" id="edit-desc">
        </div>
        <div class="section-title">Preguntas</div>
        <div id="edit-preguntas-container"></div>
        <button class="btn btn-secondary" onclick="agregarPregunta()" style="margin-bottom:12px">‚ûï Agregar pregunta</button>
        <button class="btn" onclick="guardarEdicion()">üíæ Guardar cambios</button>
        <button class="btn btn-secondary" onclick="cerrarModal('modal-editar');abrirPanelAdmin()">Cancelar</button>
    </div>
</div>

<script>
// ============================================================
// ‚öôÔ∏è CONFIGURACI√ìN
// ============================================================
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWg0jQtR8sEWoglZ-RBtgAa5I05gNw_IwgIIEbPMmiZ5zdJSrb-7M6PDFJQBRfFmjGWw/exec';
const ADMIN_PASSWORD    = 'fequundar2024';
// ============================================================

// ‚îÄ‚îÄ Estado global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let nombreAlumno = '', cedulaAlumno = '';
let quizActual = null, claveActual = '', claveEditando = '';
let preguntaIdx = 0, respuestas = [], respondioActual = false;
let opcionSeleccionada = null;
const LETRAS = ['A','B','C','D'];

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function entrar() {
    const nombre = document.getElementById('inp-nombre').value.trim();
    const cedula = document.getElementById('inp-cedula').value.trim();
    if (!nombre || !cedula) { alert('Por favor ingresa tu nombre y n√∫mero de identificaci√≥n'); return; }
    nombreAlumno = nombre; cedulaAlumno = cedula;
    mostrarCatalogo();
}
function cerrarSesion() {
    nombreAlumno = ''; cedulaAlumno = '';
    document.getElementById('inp-nombre').value = '';
    document.getElementById('inp-cedula').value = '';
    mostrar('login-section');
}

// ‚îÄ‚îÄ CAT√ÅLOGO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mostrarCatalogo() {
    mostrar('catalogo-section');
    document.getElementById('bienvenida-msg').textContent =
        `üëã Hola, ${nombreAlumno} ¬∑ ID: ${cedulaAlumno} ‚Äî Elige un cuestionario.`;
    const grid = document.getElementById('cuestionarios-grid');
    grid.innerHTML = '<p style="color:#aaa;grid-column:1/-1;text-align:center;padding:20px">‚è≥ Cargando cuestionarios...</p>';

    const script = document.createElement('script');
    window._quizzesCallback = function(data) {
        document.getElementById('jsonp-quizzes') && document.getElementById('jsonp-quizzes').remove();
        window._quizzesCache = {};
        grid.innerHTML = '';
        if (!data || !data.length) {
            grid.innerHTML = '<p style="color:#bbb;grid-column:1/-1;text-align:center;padding:20px">No hay cuestionarios disponibles.</p>';
            return;
        }
        data.forEach(d => {
            window._quizzesCache[d.id] = d;
            const card = document.createElement('div');
            card.className = 'quiz-card';
            card.innerHTML = `
                <div class="emoji">${d.emoji||'üìù'}</div>
                <div class="titulo">${d.titulo}</div>
                <div class="desc">${d.descripcion}</div>
                <div class="npregs">${d.preguntas.length} preguntas</div>`;
            card.onclick = () => iniciarCuestionario(d.id);
            grid.appendChild(card);
        });
    };
    script.id    = 'jsonp-quizzes';
    script.src   = GOOGLE_SCRIPT_URL + '?action=quizzes&callback=_quizzesCallback';
    script.onerror = function() {
        grid.innerHTML = '<p style="color:#c62828;grid-column:1/-1;text-align:center;padding:20px">‚ö†Ô∏è No se pudieron cargar los cuestionarios.</p>';
    };
    document.body.appendChild(script);
}

// ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function iniciarCuestionario(id) {
    const cache = window._quizzesCache || {};
    claveActual = id;
    quizActual  = cache[id];
    if (!quizActual) { alert('Error al cargar el cuestionario. Intenta de nuevo.'); return; }
    respuestas  = new Array(quizActual.preguntas.length).fill(null);
    preguntaIdx = 0;
    mostrar('quiz-section');
    document.getElementById('quiz-title').textContent  = (quizActual.emoji||'') + ' ' + quizActual.titulo;
    document.getElementById('quiz-alumno').textContent = `${nombreAlumno} ¬∑ ID: ${cedulaAlumno}`;
    renderPreguntaActual();
}

function renderPreguntaActual() {
    const p     = quizActual.preguntas[preguntaIdx];
    const total = quizActual.preguntas.length;
    respondioActual  = false;
    opcionSeleccionada = null;

    document.getElementById('pregunta-badge').textContent = `${preguntaIdx+1} / ${total}`;
    document.getElementById('progress-bar').style.width   = ((preguntaIdx / total) * 100) + '%';
    document.getElementById('question-text').textContent  = p.pregunta;

    const cont = document.getElementById('options-container');
    cont.innerHTML = '';
    p.opciones.forEach((op, j) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerHTML = `<span class="letra">${LETRAS[j]}</span> ${escHtml(op)}`;
        btn.onclick = () => seleccionarOpcion(j);
        cont.appendChild(btn);
    });

    const fb = document.getElementById('feedback-inline');
    fb.style.display = 'none';
    fb.className = 'feedback-inline';

    document.getElementById('btn-confirmar').style.display = 'block';
    document.getElementById('btn-confirmar').disabled = true;
    document.getElementById('btn-siguiente').style.display = 'none';
}

function seleccionarOpcion(j) {
    if (respondioActual) return;
    opcionSeleccionada = j;
    document.querySelectorAll('.option-btn').forEach((btn, i) => {
        btn.classList.remove('correcta','incorrecta','opacada');
        btn.style.borderColor = i === j ? '#1a6fc4' : '';
        btn.style.background  = i === j ? '#e8f0fb' : '';
        btn.querySelector('.letra').style.background = i === j ? '#1a6fc4' : '';
        btn.querySelector('.letra').style.color      = i === j ? 'white'   : '';
    });
    document.getElementById('btn-confirmar').disabled = false;
}

function confirmarRespuesta() {
    if (opcionSeleccionada === null) return;
    respondioActual = true;
    const p        = quizActual.preguntas[preguntaIdx];
    const correcta = p.correcta;
    const elegida  = opcionSeleccionada;
    const esOk     = elegida === correcta;
    respuestas[preguntaIdx] = elegida;

    document.querySelectorAll('.option-btn').forEach((btn, i) => {
        btn.disabled = true;
        btn.style.borderColor = ''; btn.style.background = '';
        btn.querySelector('.letra').style.background = '';
        btn.querySelector('.letra').style.color = '';
        if (i === correcta)             btn.classList.add('correcta');
        else if (i === elegida && !esOk) btn.classList.add('incorrecta');
        else                             btn.classList.add('opacada');
    });

    const fb = document.getElementById('feedback-inline');
    fb.className = `feedback-inline ${esOk ? 'correcto' : 'incorrecto'}`;
    fb.style.display = 'block';
    document.getElementById('fb-icon').textContent   = esOk ? '‚úÖ' : '‚ùå';
    document.getElementById('fb-titulo').textContent = esOk ? '¬°Correcto!' : 'Incorrecto';
    document.getElementById('fb-titulo').className   = `fb-titulo ${esOk ? 'correcto' : 'incorrecto'}`;

    const fbCorrecta = document.getElementById('fb-correcta');
    if (!esOk) {
        fbCorrecta.innerHTML = `La respuesta correcta era: <strong>${escHtml(p.opciones[correcta])}</strong>`;
        fbCorrecta.style.display = 'block';
    } else {
        fbCorrecta.style.display = 'none';
    }

    const expBox = document.getElementById('fb-explicacion');
    if (p.explicacion) {
        expBox.innerHTML = `<strong>üí° Explicaci√≥n:</strong> ${escHtml(p.explicacion)}`;
        expBox.style.display = 'block';
    } else {
        expBox.style.display = 'none';
    }

    fb.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    document.getElementById('btn-confirmar').style.display = 'none';
    const btnSig = document.getElementById('btn-siguiente');
    btnSig.textContent   = preguntaIdx === quizActual.preguntas.length - 1 ? 'Ver resultado final ‚Üí' : 'Siguiente pregunta ‚Üí';
    btnSig.style.display = 'block';
    opcionSeleccionada   = null;
}

function siguientePregunta() {
    preguntaIdx++;
    if (preguntaIdx < quizActual.preguntas.length) {
        renderPreguntaActual();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        mostrarResultadoFinal();
    }
}

// ‚îÄ‚îÄ RESULTADO FINAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mostrarResultadoFinal() {
    const correctas   = respuestas.filter((r,i) => r === quizActual.preguntas[i].correcta).length;
    const total       = quizActual.preguntas.length;
    const incorrectas = total - correctas;
    const pct         = Math.round(correctas / total * 100);

    const circle = document.getElementById('score-circle');
    circle.className = 'score-circle ' + (pct>=80?'score-excelente':pct>=60?'score-bien':'score-bajo');
    document.getElementById('score-number').textContent  = correctas;
    document.getElementById('score-total').textContent   = total;
    document.getElementById('result-titulo').textContent = quizActual.titulo;
    document.getElementById('result-msg').textContent    =
        pct>=80 ? 'üéâ ¬°Excelente trabajo!' :
        pct>=60 ? 'üëç Buen esfuerzo, sigue practicando' :
                  'üí™ Contin√∫a estudiando, t√∫ puedes';
    document.getElementById('saving-msg').style.display  = 'block';
    document.getElementById('sheets-status').textContent = '';

    document.getElementById('resumen-grid').innerHTML = `
        <div class="resumen-box"><div class="val" style="color:#2e7d32">${correctas}</div><div class="lbl">Correctas</div></div>
        <div class="resumen-box"><div class="val" style="color:#c62828">${incorrectas}</div><div class="lbl">Incorrectas</div></div>
        <div class="resumen-box"><div class="val">${pct}%</div><div class="lbl">Porcentaje</div></div>`;

    mostrar('result-section');
    window.scrollTo({ top: 0, behavior: 'smooth' });
    enviarASheets(correctas, pct);
}

function enviarASheets(correctas, porcentaje) {
    const datos = {
        fecha: new Date().toLocaleString('es-CO'),
        nombre: nombreAlumno, cedula: cedulaAlumno,
        cuestionario: quizActual.titulo,
        correctas, total: quizActual.preguntas.length,
        porcentaje: porcentaje + '%',
        respuestas: respuestas.join(',')
    };
    fetch(GOOGLE_SCRIPT_URL, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(datos)
    })
    .then(() => {
        document.getElementById('saving-msg').style.display = 'none';
        document.getElementById('sheets-status').innerHTML =
            '<span style="color:#2e7d32;font-weight:600;font-size:0.87rem">‚úÖ Resultado guardado correctamente</span>';
    })
    .catch(() => {
        document.getElementById('saving-msg').style.display = 'none';
        document.getElementById('sheets-status').innerHTML =
            '<span style="color:#c62828;font-weight:600;font-size:0.87rem">‚ö†Ô∏è No se pudo guardar.</span>';
    });
}

// ‚îÄ‚îÄ ADMIN LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function abrirLoginAdmin() {
    document.getElementById('inp-admin-pass').value = '';
    document.getElementById('modal-login-admin').classList.add('active');
    setTimeout(() => document.getElementById('inp-admin-pass').focus(), 150);
}
function verificarAdmin() {
    if (document.getElementById('inp-admin-pass').value === ADMIN_PASSWORD) {
        cerrarModal('modal-login-admin'); abrirPanelAdmin();
    } else { alert('Contrase√±a incorrecta'); }
}

// ‚îÄ‚îÄ PANEL ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function abrirPanelAdmin() {
    renderAdminLista();
    document.getElementById('modal-admin').classList.add('active');
}
function cambiarTab(tabId, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
    if (tabId === 'tab-resultados') cargarResultados();
}

// ‚îÄ‚îÄ CUESTIONARIOS ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAdminLista() {
    const container = document.getElementById('admin-lista-cuestionarios');
    container.innerHTML = '<p style="color:#aaa;font-size:0.88rem">‚è≥ Cargando...</p>';

    const script = document.createElement('script');
    window._adminQuizzesCallback = function(data) {
        document.getElementById('jsonp-admin-quizzes') && document.getElementById('jsonp-admin-quizzes').remove();
        window._quizzesCache = {};
        container.innerHTML = '';
        if (!data || !data.length) {
            container.innerHTML = '<p style="color:#bbb;margin-bottom:10px">Sin cuestionarios a√∫n.</p>';
            return;
        }
        data.forEach(d => {
            window._quizzesCache[d.id] = d;
            const item = document.createElement('div');
            item.className = 'quiz-admin-item';
            item.innerHTML = `
                <div class="info">
                    <strong>${d.emoji||'üìù'} ${d.titulo}</strong>
                    <span>${d.preguntas.length} preguntas ¬∑ ${d.descripcion}</span>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary btn-sm" onclick="abrirEditar('${d.id}')">‚úèÔ∏è Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="eliminarCuestionario('${d.id}')">üóëÔ∏è</button>
                </div>`;
            container.appendChild(item);
        });
    };
    script.id    = 'jsonp-admin-quizzes';
    script.src   = GOOGLE_SCRIPT_URL + '?action=quizzes&callback=_adminQuizzesCallback';
    script.onerror = function() {
        container.innerHTML = '<p style="color:#c62828">‚ö†Ô∏è No se pudieron cargar los cuestionarios.</p>';
    };
    document.body.appendChild(script);
}

function crearCuestionario() {
    const emoji  = document.getElementById('new-emoji').value.trim()  || 'üìù';
    const titulo = document.getElementById('new-titulo').value.trim();
    const desc   = document.getElementById('new-desc').value.trim();
    if (!titulo) { alert('El t√≠tulo es obligatorio'); return; }

    const nuevoQuiz = {
        accion      : 'guardarQuiz',
        id          : 'quiz_' + Date.now(),
        titulo      : titulo,
        emoji       : emoji,
        descripcion : desc,
        preguntas   : []
    };
    fetch(GOOGLE_SCRIPT_URL, {
        method : 'POST',
        mode   : 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body   : JSON.stringify(nuevoQuiz)
    }).then(() => {
        document.getElementById('new-emoji').value  = '';
        document.getElementById('new-titulo').value = '';
        document.getElementById('new-desc').value   = '';
        alert(`‚úÖ "${titulo}" creado. Ahora ed√≠talo para agregar preguntas.`);
        renderAdminLista();
    }).catch(() => alert('‚ö†Ô∏è Error al crear el cuestionario.'));
}

function eliminarCuestionario(id) {
    const cache = window._quizzesCache || {};
    const quiz  = cache[id];
    if (!quiz || !confirm(`¬øEliminar "${quiz.titulo}"?`)) return;
    fetch(GOOGLE_SCRIPT_URL, {
        method : 'POST',
        mode   : 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body   : JSON.stringify({ accion: 'eliminarQuiz', id: id })
    }).then(() => {
        alert('‚úÖ Cuestionario eliminado.');
        renderAdminLista();
    }).catch(() => alert('‚ö†Ô∏è Error al eliminar.'));
}

// ‚îÄ‚îÄ EDITAR CUESTIONARIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function abrirEditar(id) {
    claveEditando = id;
    const cache = window._quizzesCache || {};
    const d = cache[id];
    if (!d) { alert('Error al cargar el cuestionario.'); return; }

    document.getElementById('editar-titulo-modal').textContent = 'Editar: ' + d.titulo;
    document.getElementById('edit-emoji').value  = d.emoji  || '';
    document.getElementById('edit-titulo').value = d.titulo || '';
    document.getElementById('edit-desc').value   = d.descripcion || '';

    const cont = document.getElementById('edit-preguntas-container');
    cont.innerHTML = '';
    d.preguntas.forEach((p, i) => agregarPreguntaConDatos(p, i));

    cerrarModal('modal-admin');
    document.getElementById('modal-editar').classList.add('active');
}

function agregarPregunta() {
    const n = document.getElementById('edit-preguntas-container').querySelectorAll('.pregunta-admin').length;
    agregarPreguntaConDatos({ pregunta:'', opciones:['','','',''], correcta:0, explicacion:'' }, n);
}

function agregarPreguntaConDatos(p, idx) {
    const cont = document.getElementById('edit-preguntas-container');
    const div  = document.createElement('div');
    div.className = 'pregunta-admin';
    div.innerHTML = `
        <label style="font-size:0.81rem;margin-bottom:4px;color:#777">Pregunta ${idx+1}</label>
        <input type="text" class="p-texto" placeholder="Escribe la pregunta aqu√≠" value="${escHtml(p.pregunta||'')}">
        <div class="opciones-admin">
            <input type="text" class="p-op" placeholder="Opci√≥n A" value="${escHtml(p.opciones[0]||'')}">
            <input type="text" class="p-op" placeholder="Opci√≥n B" value="${escHtml(p.opciones[1]||'')}">
            <input type="text" class="p-op" placeholder="Opci√≥n C" value="${escHtml(p.opciones[2]||'')}">
            <input type="text" class="p-op" placeholder="Opci√≥n D" value="${escHtml(p.opciones[3]||'')}">
        </div>
        <div class="correcta-row" style="margin-bottom:8px">
            <span>Respuesta correcta:</span>
            <select class="p-correcta">
                <option value="0" ${p.correcta===0?'selected':''}>A</option>
                <option value="1" ${p.correcta===1?'selected':''}>B</option>
                <option value="2" ${p.correcta===2?'selected':''}>C</option>
                <option value="3" ${p.correcta===3?'selected':''}>D</option>
            </select>
            <button class="btn btn-danger btn-sm" onclick="this.closest('.pregunta-admin').remove();renumerarPreguntas()">üóëÔ∏è</button>
        </div>
        <label style="font-size:0.81rem;margin-bottom:4px;color:#777">üí° Explicaci√≥n de la respuesta</label>
        <textarea class="p-explicacion" placeholder="Escribe aqu√≠ por qu√© esa es la respuesta correcta...">${escHtml(p.explicacion||'')}</textarea>`;
    cont.appendChild(div);
}

function renumerarPreguntas() {
    document.querySelectorAll('.pregunta-admin').forEach((div,i) => {
        div.querySelector('label').textContent = `Pregunta ${i+1}`;
    });
}

function guardarEdicion() {
    const emoji  = document.getElementById('edit-emoji').value.trim()  || 'üìù';
    const titulo = document.getElementById('edit-titulo').value.trim();
    const desc   = document.getElementById('edit-desc').value.trim();
    if (!titulo) { alert('El t√≠tulo es obligatorio'); return; }

    const preguntas = []; let valido = true;
    document.querySelectorAll('.pregunta-admin').forEach(div => {
        const texto       = div.querySelector('.p-texto').value.trim();
        const ops         = [...div.querySelectorAll('.p-op')].map(i => i.value.trim());
        const correcta    = parseInt(div.querySelector('.p-correcta').value);
        const explicacion = div.querySelector('.p-explicacion').value.trim();
        if (!texto || ops.some(o => !o)) { valido = false; return; }
        preguntas.push({ pregunta: texto, opciones: ops, correcta, explicacion });
    });
    if (!valido)           { alert('Completa todos los campos de cada pregunta.'); return; }
    if (!preguntas.length) { alert('Agrega al menos una pregunta.'); return; }

    fetch(GOOGLE_SCRIPT_URL, {
        method : 'POST',
        mode   : 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body   : JSON.stringify({
            accion      : 'guardarQuiz',
            id          : claveEditando,
            emoji       : emoji,
            titulo      : titulo,
            descripcion : desc,
            preguntas   : preguntas
        })
    }).then(() => {
        alert(`‚úÖ "${titulo}" guardado con ${preguntas.length} preguntas.`);
        cerrarModal('modal-editar');
        abrirPanelAdmin();
    }).catch(() => alert('‚ö†Ô∏è Error al guardar.'));
}

// ‚îÄ‚îÄ RESULTADOS ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function cargarResultados() {
    const cont = document.getElementById('resultados-contenido');
    cont.innerHTML = '<div class="loading-msg">‚è≥ Cargando datos...</div>';

    const script = document.createElement('script');
    window._jsonpCallback = function(data) {
        document.getElementById('jsonp-script') && document.getElementById('jsonp-script').remove();
        if (data.error) {
            cont.innerHTML = `<div style="background:#fff3e0;border-radius:10px;padding:16px;color:#bf360c">‚ö†Ô∏è Error: ${data.error}</div>`;
            return;
        }
        renderResultados(Array.isArray(data) ? data : []);
    };
    script.id    = 'jsonp-script';
    script.src   = GOOGLE_SCRIPT_URL + '?callback=_jsonpCallback';
    script.onerror = function() {
        document.getElementById('jsonp-script') && document.getElementById('jsonp-script').remove();
        cont.innerHTML = '<div style="background:#fff3e0;border-radius:10px;padding:16px;color:#bf360c">‚ö†Ô∏è No se pudieron cargar los resultados.</div>';
    };
    document.body.appendChild(script);
}

function renderResultados(data) {
    const cont = document.getElementById('resultados-contenido');
    if (!data || !data.length) {
        cont.innerHTML = '<div style="text-align:center;color:#bbb;padding:30px">üì≠ No hay resultados a√∫n.</div>';
        return;
    }

    const totalIntentos    = data.length;
    const estudiantesSet   = new Set(data.map(r => r['Cedula'] || r['C√©dula'] || ''));
    const totalEstudiantes = estudiantesSet.size;
    const promedioGral     = Math.round(data.reduce((s,r) => s + parsePct(r['Porcentaje']), 0) / totalIntentos);

    const porQuiz = {};
    data.forEach(r => {
        const q = r['Cuestionario'] || 'Sin nombre';
        if (!porQuiz[q]) porQuiz[q] = { suma:0, count:0 };
        porQuiz[q].suma  += parsePct(r['Porcentaje']);
        porQuiz[q].count++;
    });

    const porEstudiante = {};
    data.forEach(r => {
        const key = String(r['Cedula'] || r['C√©dula'] || '?');
        if (!porEstudiante[key]) porEstudiante[key] = { nombre: r['Nombre']||'', intentos: [] };
        porEstudiante[key].intentos.push(r);
    });

    let html = `
        <div class="stats-grid">
            <div class="stat-box"><div class="val">${totalEstudiantes}</div><div class="lbl">Estudiantes</div></div>
            <div class="stat-box"><div class="val">${totalIntentos}</div><div class="lbl">Intentos totales</div></div>
            <div class="stat-box"><div class="val">${promedioGral}%</div><div class="lbl">Promedio general</div></div>
        </div>
        <div class="section-title" style="margin-top:0">üìä Promedio por cuestionario</div>`;

    Object.entries(porQuiz).forEach(([quiz,d]) => {
        const avg   = Math.round(d.suma / d.count);
        const clase = avg>=80?'pct-high':avg>=60?'pct-mid':'pct-low';
        html += `<div class="por-quiz-row">
            <span class="qname">${escHtml(quiz)}</span>
            <span class="qstats">${d.count} intento${d.count!==1?'s':''}</span>
            <span class="pct-badge ${clase}">${avg}%</span>
        </div>`;
    });

    const quizOpts = Object.keys(porQuiz).map(q => `<option value="${escHtml(q)}">${escHtml(q)}</option>`).join('');
    html += `
        <div class="section-title">üë§ Detalle por estudiante <span style="font-weight:400;color:#aaa;font-size:0.8rem">(clic para expandir)</span></div>
        <div class="results-filters">
            <input type="text" id="filtro-nombre" placeholder="üîç Buscar nombre o ID..." oninput="filtrarTabla()">
            <select id="filtro-quiz" onchange="filtrarTabla()">
                <option value="">Todos los cuestionarios</option>${quizOpts}
            </select>
        </div>
        <div class="results-table-wrap">
        <table id="results-table">
            <thead><tr>
                <th>Nombre</th><th>ID</th><th>Intentos</th><th>Promedio</th>
            </tr></thead>
            <tbody id="results-tbody"></tbody>
        </table></div>`;

    cont.innerHTML = html;
    window._resData       = data;
    window._resEstudiante = porEstudiante;
    filtrarTabla();
}

function filtrarTabla() {
    const data        = window._resData || [];
    const estudiantes = window._resEstudiante || {};
    const busqueda    = (document.getElementById('filtro-nombre')?.value||'').toLowerCase();
    const quizFiltro  = document.getElementById('filtro-quiz')?.value||'';
    const tbody       = document.getElementById('results-tbody');
    if (!tbody) return;

    const cedulasFiltradas = Object.keys(estudiantes).filter(ced => {
        const e = estudiantes[ced];
        const matchNombre = !busqueda ||
            e.nombre.toLowerCase().includes(busqueda) ||
            ced.toLowerCase().includes(busqueda);
        const matchQuiz = !quizFiltro ||
            e.intentos.some(i => i['Cuestionario'] === quizFiltro);
        return matchNombre && matchQuiz;
    });

    if (!cedulasFiltradas.length) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#bbb;padding:20px">Sin resultados para este filtro.</td></tr>';
        return;
    }

    tbody.innerHTML = cedulasFiltradas.map(ced => {
        const e = estudiantes[ced];
        const intentosFiltrados = quizFiltro
            ? e.intentos.filter(i => i['Cuestionario'] === quizFiltro)
            : e.intentos;
        const promedio = Math.round(intentosFiltrados.reduce((s,i) => s+parsePct(i['Porcentaje']),0) / intentosFiltrados.length);
        const clase    = promedio>=80?'pct-high':promedio>=60?'pct-mid':'pct-low';
        const rowId    = 'det_' + ced.replace(/\W/g,'');
        return `
        <tr class="estudiante-row" onclick="toggleDetalle('${rowId}')">
            <td><strong>${escHtml(e.nombre)}</strong></td>
            <td style="color:#888">${escHtml(ced)}</td>
            <td style="text-align:center">${intentosFiltrados.length}</td>
            <td><span class="pct-badge ${clase}">${promedio}%</span></td>
        </tr>
        <tr class="detalle-row" id="${rowId}">
            <td colspan="4"><div class="detalle-inner">
                ${intentosFiltrados.map(i => {
                    const p  = parsePct(i['Porcentaje']);
                    const cl = p>=80?'pct-high':p>=60?'pct-mid':'pct-low';
                    return `<div class="intento-line">
                        <span class="pct-badge ${cl}" style="font-size:0.77rem">${p}%</span>
                        <span style="font-weight:600;color:#0d1b2a">${escHtml(i['Cuestionario']||'')}</span>
                        <span style="color:#aaa">${escHtml(i['Fecha']||'')}</span>
                        <span style="color:#888">${i['Correctas']}/${i['Total']} correctas</span>
                    </div>`;
                }).join('')}
            </div></td>
        </tr>`;
    }).join('');
}

function toggleDetalle(id) {
    const row = document.getElementById(id);
    if (!row) return;
    row.style.display = row.style.display === 'table-row' ? 'none' : 'table-row';
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parsePct(v) { return parseInt(String(v).replace('%',''))||0; }
function mostrar(id) {
    ['login-section','catalogo-section','quiz-section','result-section']
        .forEach(s => document.getElementById(s).classList.toggle('hidden', s!==id));
}
function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
function escHtml(s) {
    return String(s)
        .replace(/&/g,'&amp;')
        .replace(/"/g,'&quot;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
}
</script>
</body>
</html>
